<!DOCTYPE html>
<html>
<head>
    <link rel="icon" href="Images/favicon.png">
    <title>BP Web Control Room</title>
    <style>
        html,
        body {
            margin: 0px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 60%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #sessions-context-menu {
            position: fixed;
            z-index: 10000;
            width: 150px;
            background: #f0f0f0;
            border-radius: 3px;
            border: 1px solid black;
            font-family: "Open Sans", sans-serif;
            display: none;
        }
        #sessions-context-menu.visible {
            display: block;
        }
        #sessions-context-menu .item {
            padding: 8px 10px;
            font-size: 15px;
            color: #111;
            cursor: pointer;
            border-radius: inherit;
        }
        #sessions-context-menu .item:hover {
            background: #90c8f6;
        }

        ul, .items-list {
            list-style-type: none;
            width: max-content;
        }
        .items-list, #control-items-list {
            margin: 0;
            padding: 0;
        }
        ul {
            padding-left: 40px;
        }

        .caret {
            cursor: default;
            user-select: none; /* Prevent text selection */
        }
        .caret::before {
            content: "\229E";
            color: black;
            display: table-caption;
            margin-right: 6px;
            font-size:10px;
        }
        .caret-down::before {
            content: "\229F";
        }
        .nested {
            display: none;
        }
        .active {
            display: block;
        } 

        .simple {
            cursor:default;
            user-select:none;
        }
        .selected {
            border: 1px solid #0000ff;
            background-color: #b9d9f4;
        }
        tr.selected {
            background-color: #0078d7;
            color: white !important;
        }

        .dragged-over {
            background-color: #0d2a48;
            color: white;
        }
        .dragged-over div {
            color: white !important;
        }

        table {
            min-width: 100%;
            user-select: none;
        }
        th {
            border-right: 1px solid #a0a0a0;
            padding: 2px 5px 2px 5px;
            white-space: nowrap;
            overflow: hidden;
            position: sticky;
            top: 0px;
            background: #f6f6f6
        }
        td {
            padding: 2px 5px 2px 5px;
            white-space: nowrap;
            overflow: hidden;
            border: none;
        }
        tr {
            cursor: default;
        }

        #work-queues-table, #work-items-table, #sessions-table {
            border-spacing: 0;
        }
        #work-queues-table td, #work-items-table td {
            border: 1px solid #eeeeee;
        }
        #work-queues-table .selected td, #work-items-table .selected td {
            border: none;
        }
        #sessions-table td {
            border: 1px thick #eeeeee;
        }

        #sessions-refresh:hover, #queues-refresh:hover {
            background-color: #518bc7;
        }
        #sessions-refresh:active, #queues-refresh:active {
            background-color: #4070a1;
        }

        #sign-out:hover, #settings:hover {
            background-color: #b3d7f3;
            border: 1px solid #0591ff;
        }
    </style>
</head>
<body onclick="clickContextMenuHandler(event)" oncontextmenu="((e) => e.preventDefault())(event)">
    <div id="modal-window-settings" class="modal">
        <div class="modal-content">
            <table>
                <tr>
                    <td>
                        <label for="api-url">
                            BP Control room web API URL:
                        </label>
                    </td>
                    <td>
                        <input type="text" id="api-url" size="50" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="refresh-frequency">
                            Frequency of refresh, sec (min 30):
                        </label>
                    </td>
                    <td>
                        <input type="number" id="refresh-frequency" min="30" size="50" />
                    </td>
                </tr>
            </table>
            <br /><br />
            <div style="display: flex; width: 100%; align-items: center; justify-content: space-around;">
                <button id="btn-apply-settings" onclick="applySettings()">Apply</button>
            </div>
        </div>
    </div>
    <div id="modal-window-inputs" class="modal">
    </div>
    <div id="sessions-context-menu" onclick="selectMenuOptionHandler(event)">
        <div class="item" onclick="stopSession()">Request Stop</div>
    </div>
    <div style="position: fixed; top: 0; bottom: 0; left: 0; right: 0; display: flex; flex-direction: column">
        <div id="sign-in-view" style="background-color: #f0f0f0; display: flex; justify-content: space-around;flex-grow:1">
            <div id="sign-in-details" style="background-color:white; width:60%; border: 1px solid black;margin:50px; padding: 10px;">
                <h2>Sign in to Blue Prism</h2>
                <p>Connection</p>
                <select id="select-connection" style="width:100%;"></select>
                <br /><br /><br />
                <fieldset>
                    <legend><b>Sign in with Blue Prism credentials</b></legend>
                    <label for="username">
                        User name
                    </label>
                    <br />
                    <input type="text" id="username" style="width:100%;" />
                    <br /><br />
                    <label for="password">
                        Password
                    </label>
                    <br />
                    <input type="password" id="password" style="width:100%;" />
                    <br />
                    <div id="login-error" style="color:red"></div>
                    <br />
                    <button id="btn-log-in" style="background-color:white; color:steelblue; height:30px; width:50%; float:right;cursor:pointer;" onclick="logIn()">Sign in using Blue Prism credentials</button>
                </fieldset>
                <div style="display:flex; justify-content:space-around;">
                    <img id="login-loading" src="Images/Wait.gif" style="width:50px; margin:5px; display:none" />
                </div>
            </div>
        </div>
        <div id="main-views" style="background-color: #fefefe; display: none; flex-direction:row; flex-grow:1; overflow-y: hidden;">
            <div id="control-view" style="height: 100%; width: 20%; display: flex; flex-direction: column; overflow: auto; font-family: Arial, Helvetica, sans-serif; ">
                <div style="height: 40px; line-height: 40px; text-align: center; background-color: #696969; color: white; font-size: large; ">
                    Control
                </div>
                <div style="padding:10px; flex-grow:1; font-size:small">
                    <ul id="control-items-list">
                    </ul>
                </div>
            </div>
            <div style="border:1px solid #808080; margin:0 2px;"></div>
            <div id="right-views-container" style="height:100%; width:80%; display:flex; flex-direction:column;">
                <div style="height: 40px; line-height: 40px; padding-left: 10px; background-color: #0d2a48; color: white; font-family: Arial, Helvetica, sans-serif; font-size: large; display:flex; justify-content:space-between;">
                    <div>Sessions - Control currently running sessions</div>
                    <div><img id="sessions-refresh" style="min-height: 30px; margin: 5px 10px 0 0;" src="Images/Btn_refresh.png" title="Refresh" onclick="getResources(); getSessions()" /></div>
                </div>
                <div id="top-right-views-container" style="flex-grow:1; width: 100%; display:flex; flex-direction:row; min-height:0; max-height:50%;">
                    <div id="available-processes-view" style="height: 100%; max-width: 50%; flex-grow: 1; display: flex; flex-direction:column;">
                        <div>
                            <b>Available processes</b>       - Drag and drop processes on to resources
                        </div>
                        <div id="processes-container" style="flex-grow:1; border: 1px solid black; margin: 2px 5px 0 5px; overflow: auto; font-family: Arial, Helvetica, sans-serif; font-size: small;">
                            <div style="height:20px; display:flex; flex-direction:row">
                                <div style="width:320px; padding-left: 10px;">Name</div>
                                <div style="border:1px solid #a0a0a0"></div>
                                <div style="padding-left:10px">Description</div>
                            </div>
                            <ul class="items-list" id="processes-list">
                            </ul>
                        </div>
                    </div>
                    <div id="resources-view" style="height: 100%; max-width: 50%; flex-grow: 1; display: flex; flex-direction: column;">
                        <div>
                            <b>Resources</b>
                        </div>
                        <div style="flex-grow:1; border: 1px solid black; margin: 2px 5px 0 5px; overflow: auto; font-family: Arial, Helvetica, sans-serif; font-size: small;">
                            <div style="height:20px; display:flex; flex-direction:row">
                                <div style="width:220px; padding-left: 10px;">Name</div>
                                <div style="border:1px solid #a0a0a0"></div>
                                <div style="padding-left:10px">State</div>
                            </div>
                            <ul class="items-list" id="resources-list">
                            </ul>
                        </div>
                    </div>
                </div>
                <div style="border:1px solid #808080; margin:2px 0;">

                </div>
                <div id="environment-view" style="flex-grow:1; width: 100%; display:flex; flex-direction:column; min-height: 0; max-height: 50%;">
                    <div>
                        <b>Environment</b>
                    </div>
                    <div style="flex-grow:1; border: 1px solid black; margin: 2px 5px 0 5px; overflow: auto; font-family: Arial, Helvetica, sans-serif; font-size: small;">
                        <div style="height:100%">
                            <table id="sessions-table">
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="queue-management-views" style="height:100%; width:80%; display:none; flex-direction:column;">
                <div style="height: 40px; line-height: 40px; padding-left: 10px; background-color: #0d2a48; color: white; font-family: Arial, Helvetica, sans-serif; font-size: large; display: flex; justify-content: space-between;">
                    <div>Queues</div>
                    <div><img id="queues-refresh" style="min-height: 30px; margin: 5px 10px 0 0;" src="Images/Btn_refresh.png" title="Refresh" onclick="getQueueItems(null)" /></div>
                </div>
                <div id="queue-view" style="flex-grow: 2; max-height: 40%; min-height: 0; display: flex; flex-direction: column">
                    <div id="queues-title" style="font-size:smaller; margin-left:5px;">
                        <b>2 queues</b>
                    </div>
                    <div style="flex-grow: 1; border: 1px solid black; margin: 2px 5px 0 5px; overflow: auto; font-family: Arial, Helvetica, sans-serif; font-size: small;">
                        <table id="work-queues-table">
                        </table>
                    </div>
                </div>
                <div id="queue-items-view" style="flex-grow: 3; max-height: 60%; min-height: 0; display: flex; flex-direction: column">
                    <div id="queue-items-title" style="font-size: smaller; margin-left: 5px;">
                        <b>Queue contents: </b>
                    </div>
                    <div style="flex-grow: 1; border: 1px solid black; margin: 2px 5px 0 5px; overflow: auto; font-family: Arial, Helvetica, sans-serif; font-size: small;">
                        <table id="work-items-table">
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div id="footer" style="height: 25px; background-color: #0d2a48; display: flex; flex-direction: row; justify-content: space-between;">
            <div id="sign-out" style="color: white; display: none; align-items: center; justify-content: space-around;padding:1px 5px; cursor:pointer; white-space:nowrap;" onclick="logOut()">
                <img src="Images/Sign_out.png" />
                Sign Out
            </div>
            <div style="display: flex; flex-direction: row-reverse; align-items: center; padding: 1px 5px; flex-grow: 1; color:white;font-size:20px;">
                <div id="settings" style="cursor:pointer;" onclick="openSettings()">
                    <span><b>&#9881;</b></span>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        let REFRESH_TIMEOUT = 60;//sec; Feel free to adjust for your purposes, here or through settings modal dialog (TODO).
        let apiUrlBase = "https://localhost:44303/";
        let authToken = "";
        let selectedQueueId = "", selectedSessionId = "";
        let refreshTimerId = 0;
        let queueManagementIsOpen = false, sessionsManagementIsOpen = false;
        let processes, resources, sessions, queues, queueItems;

        function openSettings() {
            document.getElementById("api-url").value = apiUrlBase;
            document.getElementById("refresh-frequency").value = REFRESH_TIMEOUT;
            document.getElementById("modal-window-settings").style.display = "block";
        }
        function applySettings() {
            apiUrlBase = document.getElementById("api-url").value;
            REFRESH_TIMEOUT = document.getElementById("refresh-frequency").value;
            if (REFRESH_TIMEOUT < 30) {
                REFRESH_TIMEOUT = 30;
            }
            if (queueManagementIsOpen || sessionsManagementIsOpen) {// restart timer with a new delay
                clearTimeout(refreshTimerId);
                refreshTimerId = setInterval(refreshViews, REFRESH_TIMEOUT * 1000);
            }

            initConnectionsList();
            document.getElementById("modal-window-settings").style.display = "none";
        }
        function logIn() {
            var data = {
                ConnectionName: document.getElementById("select-connection").value,
                Username: document.getElementById("username").value,
                Password: document.getElementById("password").value
            };

            document.getElementById("login-loading").style.display = "inline";

            fetch(apiUrlBase + "connections/login", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data)
            }).then(res => res.text())
                .then(data => {
                    const regex = new RegExp(/^([a-zA-Z0-9_=]+)\.([a-zA-Z0-9_=]+)\.([a-zA-Z0-9_\-\+\/=]*)/gm);
                    if (regex.test(data)) {
                        authToken = data;
                        document.getElementById("login-error").innerHTML = "";
                        switchToPostAuthView();
                    }
                    else {
                        document.getElementById("login-error").innerHTML = data;
                    }
                    document.getElementById("login-loading").style.display = "none";
                })
                .catch(err => {
                    document.getElementById("login-error").innerHTML = err;
                    document.getElementById("login-loading").style.display = "none";
                });
        }
        function logOut() {
            authToken = "";
            switchToAuthView();
        }
        window.onclick = function (event) {
            var modal = document.getElementById("modal-window-settings");
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
        document.getElementById("password").addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                logIn();
            }
        });

        function refreshAllSessionManagement() {
            getProcesses();
            getResources();
            getSessions();
            getQueues();
        }
        function refreshViews() {
            if (sessionsManagementIsOpen) {
                getResources();
                getSessions();
            }
            if (queueManagementIsOpen) {
                //getQueueItems(null); It's more comfortable updating it manually by Refresh button
            }
        }
        function switchToAuthView() {
            document.getElementById("sign-in-view").style.display = "flex";
            document.getElementById("sign-out").style.display = "none";
            document.getElementById("main-views").style.display = "none";

            sessionsManagementIsOpen = false;
            queueManagementIsOpen = false;

            clearTimeout(refreshTimerId);
        }
        function switchToPostAuthView() {
            document.getElementById("sign-in-view").style.display = "none";
            document.getElementById("sign-out").style.display = "flex";
            document.getElementById("main-views").style.display = "flex";

            openSessionManagement();
            sessionsManagementIsOpen = true;
            refreshTimerId = setInterval(refreshViews, REFRESH_TIMEOUT * 1000);
        }
        function initConnectionsList() {
            var combobox = document.getElementById("select-connection");
            combobox.innerHTML = "";
            fetch(apiUrlBase + "Connections")
                .then((res) => res.json())
                .then((data) => {
                    data.forEach((i) => combobox.add(new Option(i, i), undefined));
                });
        }

        function openSessionManagement() {
            document.getElementById("queue-management-views").style.display = "none";
            document.getElementById("right-views-container").style.display = "flex";

            sessionsManagementIsOpen = true;
            queueManagementIsOpen = false;
            refreshAllSessionManagement();
        }
        function openQueueManagement() {
            document.getElementById("queue-management-views").style.display = "flex";
            document.getElementById("right-views-container").style.display = "none";

            sessionsManagementIsOpen = false;
            queueManagementIsOpen = true;
        }

        function handleCaretClick(elem) {
            elem.parentElement.querySelector(".nested").classList.toggle("active");
            elem.classList.toggle("caret-down");
        }

        function selectItem(elem) {
            var listElements = document.querySelectorAll("li.simple");
            for (var i = 0; i < listElements.length; i++)
                listElements[i].classList.remove("selected");
            var tableRows = document.querySelectorAll("tbody tr");
            for (var j = 0; j < tableRows.length; j++)
                tableRows[j].classList.remove("selected");
            elem.classList.toggle("selected");
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }
        function dragStartHandler(e) {
            var procId = e.target.id;
            e.dataTransfer.setData("procId", procId);

            var img = new Image();
            img.src = "Images/Process.png";
            e.dataTransfer.setDragImage(img, -5, -5);
            document.getElementById("processes-container").style.overflow = "hidden";
        }
        function dragEndHandler(e) {
            document.getElementById("processes-container").style.overflow = "auto";
        }
        function dragEnterHandler(elem) {
            elem.classList.add("dragged-over");
        }
        function dragLeaveHandler(elem) {
            elem.classList.remove("dragged-over");
        }
        function dropHandler(e) {
            e.target.closest("li").classList.remove("dragged-over");

            var procId = e.dataTransfer.getData("procId");
            var process = processes.map((g) => g.processes).flat().filter((p) => p.id == procId)[0];
            var resourceName = e.target.closest("li").children[0].children[0].innerText;
            if (process.processInput == "") {
                startSession(process.processName, resourceName);
            }
            else {
                const parser = new DOMParser();
                const doc = parser.parseFromString(process.processInput, "application/xml");
                var inputs = doc.querySelectorAll("input");
                var htmlContent = '<div class="modal-content"><h2>Startup Parameters</h2><table>';
                for (var i = 0; i < inputs.length; i++) {
                    htmlContent += '<tr><td><label for= "' + inputs[i].getAttribute("name") + '">'
                        + inputs[i].getAttribute("name") + '</label></td>'
                        + '<td><input type="' + inputs[i].getAttribute("type").replace("datetime", "datetime-local").replace("flag", "checkbox")
                        + '" id="' + inputs[i].getAttribute("name") + '" size="50" title="' + ((inputs[i].getAttribute("narrative")) ?? '') + '"/></td></tr>';
                }
                htmlContent += '</table><br/><br/><div style = "display: flex; width: 100%; align-items: center; justify-content: space-around;" >'
                    + '<input type="hidden" id="input-process-name" value="' + process.processName + '" />'
                    + '<input type="hidden" id="input-resource-name" value="' + resourceName + '" />'
                    + '<button id="btn-apply-inputs" onclick="applyInputParams()">Start</button>'
                    + '<button id="btn-cancel-start" onclick="document.getElementById(\'modal-window-inputs\').style.display = \'none\'">Cancel</button></div >';

                var inputsWindow = document.getElementById("modal-window-inputs");
                inputsWindow.innerHTML = htmlContent;
                inputsWindow.style.display = "block";
            }
        }
        function applyInputParams() {
            var inputs = document.querySelectorAll("#modal-window-inputs table input");
            var startupParams = "<inputs>";
            for (var i = 0; i < inputs.length; i++) {
                switch (inputs[i].getAttribute("type")) {
                    case 'date':
                        if (inputs[i].value == '')
                            break;
                        startupParams += "<input name='" + inputs[i].id + "' type='date' value='" + inputs[i].value + "' />";
                        break;
                    case 'datetime-local':
                        if (inputs[i].value == '')
                            break;
                        var date = new Date(inputs[i].value);
                        startupParams += "<input name='" + inputs[i].id + "' type='datetime' value='" + inputs[i].value.replace('T', ' ') + ":00' />";
                        break;
                    case 'checkbox':
                        startupParams += "<input name='" + inputs[i].id + "' type='flag' value='" + (inputs[i].checked ? 'True' : 'False') + "' />";
                        break;
                    case 'number':
                        if (inputs[i].value == '')
                            break;
                        startupParams += "<input name='" + inputs[i].id + "' type='number' value='" + inputs[i].value + "' />";
                        break;
                    case 'password':
                        if (inputs[i].value == '')
                            break;
                        startupParams += "<input name='" + inputs[i].id + "' type='password' value='" + inputs[i].value + "' />";
                        break;
                    case 'text':
                        startupParams += "<input name='" + inputs[i].id + "' type='text' value='" + inputs[i].value + "' />";
                        break;
                    case 'time':
                        if (inputs[i].value == '')
                            break;
                        startupParams += "<input name='" + inputs[i].id + "' type='time' value='" + inputs[i].value + "' />";
                        break;
                }
            }
            startupParams += "</inputs>";
            var processName = document.getElementById("input-process-name").value;
            var resourceName = document.getElementById("input-resource-name").value;
            document.getElementById("modal-window-inputs").style.display = "none";

            startSession(processName, resourceName, startupParams);
        }

        function expandTreeView(elemId) {
            var expandableItems = document.querySelectorAll("#" + elemId + " .caret");
            for (var i = 0; i < expandableItems.length; i++) {
                expandableItems[i].click();
            }
        };

        function updateProcessesList() {
            var htmlContent = "";
            for (var i = 0; i < processes.length; i++) {
                htmlContent += '<li><span class="caret" onclick = "handleCaretClick(this)"><img src="Images/Folder.png"/>'
                    + processes[i].group
                    + '</span><ul class="nested">';
                for (var j = 0; j < processes[i].processes.length; j++) {
                    htmlContent += '<li id="' + processes[i].processes[j].id + '" class="simple" draggable="true" onclick="selectItem(this)" ondragstart="dragStartHandler(event)" ondragend="dragEndHandler(event)">'
                        + '<div style = "display:flex; flex-direction:row;">'
                        + '<div style="width:300px; overflow:hidden;">'
                        + '<img src="Images/Process.png" /><span>' + processes[i].processes[j].processName
                        + '</span></div><div style="width:max-content; overflow:hidden;">' + processes[i].processes[j].processDescription
                        + '</div></div ></li >';
                }
                htmlContent += '</ul ></li >';
            }
            document.getElementById("processes-list").innerHTML = htmlContent;
        }
        function getProcesses() {
            document.getElementById("processes-list").innerHTML = '<li><img id="login-loading" src="Images/Wait.gif" style="width:50px; margin:5px;" /></li>';
            fetch(apiUrlBase + "availableprocesses", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + authToken,
                }
            }).then(res => res.json())
                .then(data => {
                    processes = data;
                    updateProcessesList();
                    expandTreeView("processes-list");
                })
                .catch(err => {
                    document.getElementById("processes-list").innerHTML = '<li style="color:red;">' + err + '</li>';
                });
        }

        function updateResourcesList() {
            var htmlContent = "";
            for (var i = 0; i < resources.length; i++) {
                htmlContent += '<li><span class="caret" onclick = "handleCaretClick(this)"><img src="Images/Folder.png" />'
                    + resources[i].group
                    + '</span><ul class="nested">';
                for (var j = 0; j < resources[i].resources.length; j++) {
                    var imageFile = "", color = "color:black;";
                    switch (resources[i].resources[j].resourceStatus) {
                        case 'Idle':
                            imageFile = "R_idle.png";
                            break;
                        case 'Idle-Pending':
                        case 'Working':
                            imageFile = "R_busy.png";
                            color = "color:green;"
                            break;
                        case 'Logged Out':
                            imageFile = "R_logged_out.png";
                            break;
                        default://Missing
                            imageFile = "R_missing.png";
                            color = "color:red;"
                            break;
                    }
                    htmlContent += '<li class="simple" ondragover="allowDrop(event)" onclick="selectItem(this)" ondragenter="dragEnterHandler(this)" ondragleave="dragLeaveHandler(this)" ondrop="dropHandler(event)">'
                        + '<div style = "display:flex; flex-direction:row;' + color + '">'
                        + '<div style="width:200px; overflow:hidden;">'
                        + '<img src="Images/' + imageFile + '">'
                        + resources[i].resources[j].resourceName
                        + '</div><div style="width:max-content; overflow:hidden;">'
                        + resources[i].resources[j].resourceStatus
                        + '</div></div ></li >';
                }
                htmlContent += '</ul ></li >';
            }
            document.getElementById("resources-list").innerHTML = htmlContent;
        }
        function getResources() {
            document.getElementById("resources-list").innerHTML = '<li><img id="login-loading" src="Images/Wait.gif" style="width:50px; margin:5px;" /></li>';
            fetch(apiUrlBase + "resources", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + authToken,
                }
            }).then(res => res.json())
                .then(data => {
                    resources = data;
                    updateResourcesList();
                    expandTreeView("resources-list");
                })
                .catch(err => {
                    document.getElementById("resources-list").innerHTML = '<li style="color:red;">' + err + '</li>';
                });
        }

        function updateSessionsList() {
            var htmlContent = '<thead>'
                + '<tr style = "text-align: left;">'
                + '<th>ID</th><th>Process</th><th>Resource</th><th>User</th>'
                + '<th>Status</th><th>Start Time</th><th>End Time</th><th>Latest Stage</th></tr >'
                + '</thead ><tbody>';
            var color = '';
            for (var i = 0; i < sessions.length; i++) {
                switch (sessions[i].status) {
                    case 'Completed':
                        color = 'style="color:blue"';
                        break;
                    case 'Stopped':
                        color = 'style="color:red"';
                        break;
                    case 'Terminated':
                        color = 'style="color:black"';
                        break;
                    case 'Pending':
                        color = 'style="color:orange"';
                        break;
                    default:
                        color = 'style="color:green"';
                        break;
                }
                htmlContent += '<tr id="' + sessions[i].id + '" onclick="selectItem(this)" oncontextmenu="contextMenuHandler(event)" ' + color + '>';
                htmlContent += '<td>' + sessions[i].number + '</td>'
                    + '<td>' + sessions[i].process + '</td>'
                    + '<td>' + sessions[i].resource + '</td>'
                    + '<td>' + sessions[i].user + '</td>'
                    + '<td>' + sessions[i].status + '</td>'
                    + '<td>' + new Date(sessions[i].startTime).toISOString().split('.')[0].replace('T', ' ') + '</td>'
                    + '<td>' + (sessions[i].endTime == null ? '' : new Date(sessions[i].endTime).toISOString().split('.')[0].replace('T', ' ')) + '</td>'
                    + '<td>' + (sessions[i].latestStage == null ? '' : sessions[i].latestStage) + '</td></tr>';
            }
            htmlContent += '</tbody>';
            document.getElementById("sessions-table").innerHTML = htmlContent;
        }
        function getSessions() {
            document.getElementById("sessions-table").innerHTML = '<tr><td><img id="login-loading" src="Images/Wait.gif" style="width:50px; margin:5px;" /></td></tr>';
            fetch(apiUrlBase + "environment", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + authToken,
                }
            }).then(res => res.json())
                .then(data => {
                    sessions = data;
                    updateSessionsList();
                })
                .catch(err => {
                    document.getElementById("sessions-table").innerHTML = '<tbody><tr style="color:red;"><td>' + err + '</td></tr></tbody>';
                });
        }
        function startSession(process, resource, inputs = null) {
            var data = {
                ProcessName: process,
                ResourceName: resource,
                InputParameters: inputs
            };
            fetch(apiUrlBase + "environment", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + authToken,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            }).then(res => res.text())
                .then(text => {
                    if (text.startsWith("Success")) {
                        getResources();
                        getSessions();
                    }
                    else {
                        alert(text);
                    }
                })
                .catch(err => {
                    alert(err);
                });
        }
        function stopSession() {
            document.getElementById("sessions-context-menu").classList.remove("visible");

            fetch(apiUrlBase + "environment/" + selectedSessionId, {
                method: "DELETE",
                headers: {
                    "Authorization": "Bearer " + authToken
                }
            }).then(res => res.text())
                .then(text => {
                    if (text.startsWith("Success")) {
                        getResources();
                        getSessions();
                    }
                    else {
                        alert(text);
                    }
                })
                .catch(err => {
                    alert(err);
                });
        }

        function updateQueuesList() {
            var htmlContent = '<li id="session-management" class="simple" style="padding-left:15px;margin-bottom:5px;" onclick="selectItem(this); openSessionManagement()">'
                + '<img src = "Images/Session_mngmt.png" /> Session Management'
                + '</li ><li><span class="caret" onclick="handleCaretClick(this)"><img src="Images/Queue_mngmt.png" />Queue Management</span>'
                + '<ul class="nested">';
            for (var i = 0; i < queues.length; i++) {
                if (queues[i].group != null) {
                    htmlContent += '<li><span class="caret" onclick = "handleCaretClick(this)" > <img src="Images/Folder.png" />'
                        + queues[i].group + '</span>'
                        + '<ul class="nested">';
                    for (var j = 0; j < queues[i].workQueues.length; j++) {
                        htmlContent += '<li id="' + queues[i].workQueues[j].id +
                            '" class="simple" onclick="selectItem(this); updateQueuesTable(this); getQueueItems(this); openQueueManagement()">'
                            + '<img src="Images/Wq.png" />'
                            + queues[i].workQueues[j].workQueueName + '</li>';
                    }
                    htmlContent += '</ul></li>';
                }
                else {
                    for (var j = 0; j < queues[i].workQueues.length; j++) {
                        htmlContent += '<li id="' + queues[i].workQueues[j].id +
                            '" class="simple" onclick="selectItem(this); updateQueuesTable(this); getQueueItems(this); openQueueManagement()">'
                            + '<img src="Images/Wq.png" />'
                            + queues[i].workQueues[j].workQueueName + '</li>';
                    }
                }
            }
            htmlContent += '</ul></li>';
            document.getElementById("control-items-list").innerHTML = htmlContent;
        }
        function getQueues() {
            document.getElementById("control-items-list").innerHTML = '<li><img id="login-loading" src="Images/Wait.gif" style="width:50px; margin:5px;" /></tr>';
            fetch(apiUrlBase + "queuemanagement", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + authToken,
                }
            }).then(res => res.json())
                .then(data => {
                    queues = data;
                    updateQueuesList();
                    expandTreeView("control-items-list");
                    document.getElementById("session-management").classList.toggle("selected");
                })
                .catch(err => {
                    document.getElementById("control-items-list").innerHTML = '<li style="color:red;">' + err + '</li>';
                });
        }
        function updateQueuesTable(elem) {
            var queueId = elem.id;
            var queuesGroup = queues.filter((g) => g.workQueues.filter((q) => q.id == queueId).length == 1);
            document.getElementById("queues-title").innerHTML = '<b>' + queuesGroup[0].workQueues.length + ' queues</b>';
            var htmlContent = '<thead><tr style="text-align: left;">'
                + '<th>Queue Name</th><th>Status</th><th>Worked</th><th>Pending</th>'
                + '<th>Referred</th><th>Total</th><th>Average Case Duration</th></tr></thead><tbody>';
            for (var i = 0; i < queuesGroup[0].workQueues.length; i++) {
                htmlContent += '<tr id="' + queuesGroup[0].workQueues[i].id + '" onclick="selectItem(this);  getQueueItems(this);">'
                    + '<td><img src="Images/' + (queuesGroup[0].workQueues[i].status == "Running" ? 'Queue_running.png' : 'Queue_paused.png') + '" /> '
                    + queuesGroup[0].workQueues[i].workQueueName + '</td>'
                    + '<td>' + queuesGroup[0].workQueues[i].status + '</td>'
                    + '<td>' + queuesGroup[0].workQueues[i].workedItems + '</td>'
                    + '<td>' + queuesGroup[0].workQueues[i].pendingItems + '</td>'
                    + '<td>' + queuesGroup[0].workQueues[i].referredItems + '</td>'
                    + '<td>' + queuesGroup[0].workQueues[i].totalItems + '</td>'
                    + '<td>' + (queuesGroup[0].workQueues[i].averageCaseDuration == null ? '' : new Date(queuesGroup[0].workQueues[i].averageCaseDuration * 1000).toISOString().slice(11, 19)) + '</td></tr>';
            }
            htmlContent += '</tbody>';
            document.getElementById("work-queues-table").innerHTML = htmlContent;
        }

        function updateQueueItemsTable() {
            var htmlContent = '<thead><tr style = "text-align: left;" >'
                + '<th></th><th style="min-width:60px;">Item Key</th><th>Priority</th><th>Status</th>'
                + '<th>Tags</th><th>Resource</th><th>Attempt</th><th>Created</th><th>Last Updated</th>'
                + '<th>Next Review</th><th>Completed</th><th>Total Work Time</th><th>Exception Date</th>'
                + '<th>Exception Reason</th></tr></thead><tbody>';
            for (var i = 0; i < queueItems.length; i++) {
                var imageFile = "";
                switch (queueItems[i].state) {
                    case 'Exception':
                        imageFile = "Item_exc.png";
                        break;
                    case 'Pending':
                        imageFile = "Item_pending.png";
                        break;
                    case 'Completed':
                        imageFile = "Item_done.png";
                        break;
                    default:
                        imageFile = "Item_locked.png";
                        break;
                }
                htmlContent += '<tr onclick="selectItem(this)">'
                    + '<td><img src="Images/' + imageFile + '" /></td>'
                    + '<td>' + queueItems[i].itemKey + '</td>'
                    + '<td>' + queueItems[i].priority + '</td>'
                    + '<td>' + queueItems[i].status + '</td>'
                    + '<td>' + (queueItems[i].tag == null ? '' : queueItems[i].tag) + '</td>'
                    + '<td>' + queueItems[i].resource + '</td>'
                    + '<td>' + queueItems[i].attempt + '</td>'
                    + '<td>' + new Date(queueItems[i].created).toISOString().split('.')[0].replace("T", " ") + '</td>'
                    + '<td>' + (queueItems[i].lastUpdated == null ? '' : new Date(queueItems[i].lastUpdated).toISOString().split('.')[0].replace("T", " ")) + '</td>'
                    + '<td>' + (queueItems[i].nextReview == null ? '' : new Date(queueItems[i].nextReview).toISOString().split('.')[0].replace("T", " ")) + '</td>'
                    + '<td>' + (queueItems[i].completed == null ? '' : new Date(queueItems[i].completed).toISOString().split('.')[0].replace("T", " ")) + '</td>'
                    + '<td>' + new Date(queueItems[i].totalWorkTime * 1000).toISOString().slice(11, 19) + '</td>'
                    + '<td>' + (queueItems[i].exceptionDate == null ? '' : new Date(queueItems[i].exceptionDate).toISOString().split('.')[0].replace("T", " ")) + '</td>'
                    + '<td>' + (queueItems[i].exceptionReason == null ? '' : queueItems[i].exceptionReason) + '</td></tr>';
            }
            htmlContent += '</tbody>';
            document.getElementById("work-items-table").innerHTML = htmlContent;
        }
        function getQueueItems(elem) {
            selectedQueueId = (elem == null ? selectedQueueId : elem.id);
            document.getElementById("work-items-table").innerHTML = '<tr><td><img id="login-loading" src="Images/Wait.gif" style="width:50px; margin:5px;" /></td></tr>';
            fetch(apiUrlBase + "queuecontents/" + selectedQueueId, {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + authToken,
                }
            }).then(res => res.json())
                .then(data => {
                    queueItems = data;
                    //var queueName = queues.filter((g) => g.workQueues.filter((q) => q.id == selectedQueueId).length == 1)[0].workQueues.filter((q) => q.id == selectedQueueId)[0].workQueueName;
                    var queueName = queues.map((g) => g.workQueues).flat().filter((q) => q.id == selectedQueueId)[0].workQueueName;
                    document.getElementById("queue-items-title").innerHTML = '<b>Queue contents: ' + queueName + '</b>';
                    updateQueueItemsTable();
                })
                .catch(err => {
                    document.getElementById("work-items-table").innerHTML = '<tbody><tr style="color:red;"><td>' + err + '</td></tr></tbody>';
                });
        }

        function contextMenuHandler(e) {
            e.preventDefault();
            selectedSessionId = e.target.closest("tr").id;
            var sessionStatus = sessions.filter((s) => s.id == selectedSessionId)[0].status;
            if (sessionStatus != "Running")
                return;

            var contextMenu = document.getElementById("sessions-context-menu");
            const { clientX: mouseX, clientY: mouseY } = e;
            contextMenu.style.top = mouseY + 'px';
            contextMenu.style.left = mouseX + 'px';
            contextMenu.classList.add("visible");
        }
        function clickContextMenuHandler(e) {
            var contextMenu = document.getElementById("sessions-context-menu");
            if (e.target.offsetParent != contextMenu) {
                contextMenu.classList.remove("visible");
            }
        }

        initConnectionsList();
    </script>
</body>
</html>