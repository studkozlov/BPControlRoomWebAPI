<!DOCTYPE html>
<html>
<head>
    <link rel="icon" href="Images/favicon.png">
    <title>BP Web Control Room</title>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.js"
            integrity="sha384-o4ufwq3oKqc7IoCcR08YtZXmgOljhTggRwxP2CLbSqeXGtitAxwYaUln/05nJjit"
            crossorigin="anonymous"></script>
    <style>
        html,
        body {
            margin: 0px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 60%;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

            .close:hover,
            .close:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }

        #sessions-context-menu, #schedules-context-menu {
            position: fixed;
            z-index: 10000;
            width: 150px;
            background: #f0f0f0;
            border-radius: 3px;
            border: 1px solid black;
            font-family: "Open Sans", sans-serif;
            display: none;
        }

        #sessions-context-menu.visible, #schedules-context-menu.visible {
            display: block;
        }

        #sessions-context-menu .item, #schedules-context-menu .item {
            padding: 8px 10px;
            font-size: 15px;
            color: #111;
            cursor: pointer;
            border-radius: inherit;
        }

        #sessions-context-menu .item:hover , #schedules-context-menu .item:hover {
            background: #90c8f6;
        }

        ul, .items-list {
            list-style-type: none;
            width: max-content;
        }

        .items-list, #control-items-list {
            margin: 0;
            padding: 0;
        }

        ul {
            padding-left: 40px;
        }

        .caret {
            cursor: default;
            user-select: none; /* Prevent text selection */
        }

            .caret::before {
                content: "\229E";
                color: black;
                display: table-caption;
                margin-right: 6px;
                font-size: 10px;
            }

        .caret-down::before {
            content: "\229F";
        }

        .nested {
            display: none;
        }

        .active {
            display: block;
        }

        .simple {
            cursor: default;
            user-select: none;
        }

        .selected {
            border: 1px solid #0000ff;
            background-color: #b9d9f4;
        }

        tr.selected {
            background-color: #0078d7;
            color: white !important;
        }

        .dragged-over {
            background-color: #0d2a48;
            color: white;
        }

            .dragged-over div {
                color: white !important;
            }

        table {
            min-width: 100%;
            user-select: none;
        }

        th {
            border-right: 1px solid #a0a0a0;
            padding: 2px 5px 2px 5px;
            white-space: nowrap;
            overflow: hidden;
            position: sticky;
            top: 0px;
            background: #f6f6f6
        }

        .header-2 th {
            top: 23px;
        }

        td {
            padding: 2px 5px 2px 5px;
            white-space: nowrap;
            overflow: hidden;
            border: none;
        }

        tr {
            cursor: default;
        }

        #work-queues-table, #work-items-table, #sessions-table {
            border-spacing: 0;
        }

            #work-queues-table td, #work-items-table td {
                border: 1px solid #eeeeee;
            }

            #work-queues-table .selected td, #work-items-table .selected td {
                border: none;
            }

            #sessions-table td {
                border: 1px thick #eeeeee;
            }

        #sessions-refresh:hover, #queues-refresh:hover {
            background-color: #518bc7;
        }

        #sessions-refresh:active, #queues-refresh:active {
            background-color: #4070a1;
        }

        #sign-out:hover, #settings:hover {
            background-color: #b3d7f3;
            border: 1px solid #0591ff;
        }
    </style>
</head>
<body onclick="clickContextMenuHandler(event)" oncontextmenu="((e) => e.preventDefault())(event)">
    <div id="modal-window-settings" class="modal">
        <div class="modal-content">
            <table>
                <tr>
                    <td>
                        <label for="api-url">
                            BP Control room web API URL:
                        </label>
                    </td>
                    <td>
                        <input type="text" id="api-url" size="50" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="refresh-frequency">
                            Frequency of refresh, sec (min 30):
                        </label>
                    </td>
                    <td>
                        <input type="number" id="refresh-frequency" min="30" size="50" />
                    </td>
                </tr>
            </table>
            <br /><br />
            <div style="display: flex; width: 100%; align-items: center; justify-content: space-around;">
                <button id="btn-apply-settings" onclick="applySettings()">Apply</button>
            </div>
        </div>
    </div>
    <div id="modal-window-inputs" class="modal">
    </div>
    <div id="sessions-context-menu">
        <div class="item" onclick="stopSession()" id="request-stop-option">Request Stop</div>
        <div class="item" onclick="stopSessionImmediately()" id="immediate-stop-option">Immediate Stop</div>
        <div class="item" onclick="getLogItems()">View Log</div>
    </div>
    <div id="schedules-context-menu">
        <div class="item" onclick="runSchedule()" id="run-schedule-option">Run Now</div>
    </div>
    <div style="position: fixed; top: 0; bottom: 0; left: 0; right: 0; display: flex; flex-direction: column;">
        <div id="sign-in-view" style="background-color: #f0f0f0; display: flex; justify-content: space-around;flex-grow:1">
            <div id="sign-in-details" style="background-color:white; width:60%; border: 1px solid black;margin:50px; padding: 10px;">
                <h2>Sign in to Blue Prism</h2>
                <p>Connection</p>
                <select id="select-connection" style="width:100%;"></select>
                <br /><br /><br />
                <fieldset>
                    <legend><b>Sign in with Blue Prism credentials</b></legend>
                    <label for="username">
                        User name
                    </label>
                    <br />
                    <input type="text" id="username" style="width:100%;" />
                    <br /><br />
                    <label for="password">
                        Password
                    </label>
                    <br />
                    <input type="password" id="password" style="width:100%;" />
                    <br />
                    <div id="login-error" style="color:red"></div>
                    <br />
                    <button id="btn-log-in" style="background-color:white; color:steelblue; height:30px; width:50%; float:right;cursor:pointer;" onclick="logIn()">Sign in using Blue Prism credentials</button>
                    <br /><br />
                    <div style="display:flex; justify-content:space-around;">
                        <img id="login-loading" src="Images/Wait.gif" style="width:50px; margin:5px; display:none" />
                    </div>
                </fieldset>
                <br />
                <fieldset>
                    <legend><b>Sign in with SSO</b></legend>
                    <div id="sso-login-error" style="color:red"></div>
                    <br />
                    <button style="background-color:white; color:steelblue; height:30px; width:50%; float:right;cursor:pointer;" onclick="signInSso()">Sign in with SSO (Azure AD)</button>
                    <br /><br />
                    <div style="display:flex; justify-content:space-around;">
                        <img id="sso-login-loading" src="Images/Wait.gif" style="width:50px; margin:5px; display:none" />
                    </div>
                </fieldset>
            </div>
        </div>
        <div id="main-views" style="background-color: #fefefe; display: none; flex-direction:row; flex-grow:1; overflow-y: hidden;">
            <div id="control-view" style="height: 100%; width: 20%; display: flex; flex-direction: column; overflow: auto; font-family: Arial, Helvetica, sans-serif; ">
                <div style="height: 40px; line-height: 40px; text-align: center; background-color: #696969; color: white; font-size: large; ">
                    Control
                </div>
                <div style="padding:10px; flex-grow:1; font-size:small">
                    <ul id="control-items-list">
                    </ul>
                </div>
            </div>
            <div style="border:1px solid #808080; margin:0 2px;"></div>
            <div id="right-views-container" style="height:100%; width:80%; display:flex; flex-direction:column;">
                <div style="height: 40px; line-height: 40px; padding-left: 10px; background-color: #0d2a48; color: white; font-family: Arial, Helvetica, sans-serif; font-size: large; display:flex; justify-content:space-between;">
                    <div>Sessions - Control currently running sessions</div>
                    <div><img id="sessions-refresh" style="min-height: 30px; margin: 5px 10px 0 0;" src="Images/Btn_refresh.png" title="Refresh" onclick="getResources(); getSessions()" /></div>
                </div>
                <div id="top-right-views-container" style="flex-grow:1; width: 100%; display:flex; flex-direction:row; min-height:0; max-height:50%;">
                    <div id="available-processes-view" style="height: 100%; max-width: 50%; flex-grow: 1; display: flex; flex-direction:column;">
                        <div>
                            <b>Available processes</b>       - Drag and drop processes on to resources
                        </div>
                        <div id="processes-container" style="flex-grow:1; border: 1px solid black; margin: 2px 5px 0 5px; overflow: auto; font-family: Arial, Helvetica, sans-serif; font-size: small;">
                            <div style="height:20px; display:flex; flex-direction:row">
                                <div style="width:320px; padding-left: 10px;">Name</div>
                                <div style="border:1px solid #a0a0a0"></div>
                                <div style="padding-left:10px">Description</div>
                            </div>
                            <ul class="items-list" id="processes-list">
                            </ul>
                        </div>
                    </div>
                    <div id="resources-view" style="height: 100%; max-width: 50%; flex-grow: 1; display: flex; flex-direction: column;">
                        <div>
                            <b>Resources</b>
                        </div>
                        <div style="flex-grow:1; border: 1px solid black; margin: 2px 5px 0 5px; overflow: auto; font-family: Arial, Helvetica, sans-serif; font-size: small;">
                            <div style="height:20px; display:flex; flex-direction:row">
                                <div style="width:220px; padding-left: 10px;">Name</div>
                                <div style="border:1px solid #a0a0a0"></div>
                                <div style="padding-left:10px">State</div>
                            </div>
                            <ul class="items-list" id="resources-list">
                            </ul>
                        </div>
                    </div>
                </div>
                <div style="border:1px solid #808080; margin:2px 0;">

                </div>
                <div id="environment-view" style="flex-grow:1; width: 100%; display:flex; flex-direction:column; min-height: 50%; max-height: 50%;">
                    <div>
                        <b>Environment</b>
                    </div>
                    <div style="flex-grow:1; border: 1px solid black; margin: 2px 5px 0 5px; overflow: auto; font-family: Arial, Helvetica, sans-serif; font-size: small;">
                        <div style="height:100%">
                            <table id="sessions-table">
                                <thead>
                                    <tr style="text-align: left;">
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th>
                                            <select id="session-status-filter" onchange="applySessionsFilter(this)">
                                                <option value="all" selected>All</option>
                                                <option value="Running">Running</option>
                                                <option value="Pending">Pending</option>
                                                <option value="Completed">Completed</option>
                                                <option value="Terminated">Terminated</option>
                                                <option value="Stopped">Stopped</option>
                                                <option value="Stopping">Stopping</option>
                                            </select>
                                        </th>
                                        <th>
                                            <select id="session-start-date-filter" onchange="applySessionsFilter(this)">
                                                <option value="today">Today</option>
                                                <option value="0.5">Last 30 Minutes</option>
                                                <option value="1">Last 1 Hour</option>
                                                <option value="2">Last 2 Hours</option>
                                                <option value="4">Last 4 Hours</option>
                                                <option value="12">Last 12 Hours</option>
                                                <option value="24">Last 24 Hours</option>
                                                <option value="72">Last 3 Days</option>
                                                <option value="all" selected>Last Month</option>
                                            </select>
                                        </th>
                                        <th></th>
                                        <th></th>
                                    </tr>
                                    <tr class="header-2" style="text-align: left;">
                                        <th>ID</th>
                                        <th>Process</th>
                                        <th>Resource</th>
                                        <th>User</th>
                                        <th>Status</th>
                                        <th>Start Time</th>
                                        <th>End Time</th>
                                        <th>Latest Stage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="queue-management-views" style="height:100%; width:80%; display:none; flex-direction:column;">
                <div style="height: 40px; line-height: 40px; padding-left: 10px; background-color: #0d2a48; color: white; font-family: Arial, Helvetica, sans-serif; font-size: large; display: flex; justify-content: space-between;">
                    <div>Queues</div>
                    <div><img id="queues-refresh" style="min-height: 30px; margin: 5px 10px 0 0;" src="Images/Btn_refresh.png" title="Refresh" onclick="getQueueItems(null)" /></div>
                </div>
                <div id="queue-view" style="flex-grow: 2; max-height: 40%; min-height: 0; display: flex; flex-direction: column">
                    <div id="queues-title" style="font-size:smaller; margin-left:5px;">
                        <b>2 queues</b>
                    </div>
                    <div style="flex-grow: 1; border: 1px solid black; margin: 2px 5px 0 5px; overflow: auto; font-family: Arial, Helvetica, sans-serif; font-size: small;">
                        <table id="work-queues-table">
                        </table>
                    </div>
                </div>
                <div id="queue-items-view" style="flex-grow: 3; max-height: 60%; min-height: 60%; display: flex; flex-direction: column">
                    <div id="queue-items-title" style="font-size: smaller; margin-left: 5px;">
                        <b>Queue contents: </b>
                    </div>
                    <div style="flex-grow: 1; border: 1px solid black; margin: 2px 5px 0 5px; overflow: auto; font-family: Arial, Helvetica, sans-serif; font-size: small;">
                        <table id="work-items-table">
                        </table>
                    </div>
                </div>
            </div>
            <div id="schedules-views" style="height:100%; width:80%; display:none; flex-direction:column;">
                <div style="height: 40px; line-height: 40px; padding-left: 10px; background-color: #0d2a48; color: white; font-family: Arial, Helvetica, sans-serif; font-size: large; display: flex; justify-content: space-between;">
                    <div>Schedules</div>
                </div>
                <div id="schedule-view" style="width: 100%; min-height:0; max-height:100%;">
                    <table style="padding:5px;">
                        <tr>
                            <th style="width:100px; background-color:white; border:none"></th>
                            <th style="background-color:white; border:none"></th>
                        </tr>
                        <tr>
                            <td>
                                <label for="schedule-name">
                                    Name
                                </label>
                            </td>
                            <td>
                                <input type="text" id="schedule-name" disabled style="width:99%" />
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="schedule-description">
                                    Description
                                </label>
                            </td>
                            <td>
                                <input type="text" id="schedule-description" disabled style="width:99%" />
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="initial-task">
                                    Initial Task
                                </label>
                            </td>
                            <td>
                                <input type="text" id="initial-task" disabled style="width:99%" />
                            </td>
                        </tr>
                    </table>
                </div>
                <div id="task-view" style="width: 100%; min-height:0; max-height:100%;display:none;">
                    <table style="padding:5px;">
                        <tr>
                            <th style="width: 100px; background-color: white; border: none"></th>
                            <th style="background-color:white; border:none"></th>
                        </tr>
                        <tr>
                            <td>
                                <label for="task-name">
                                    Name
                                </label>
                            </td>
                            <td>
                                <input type="text" id="task-name" disabled style="width:99%" />
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="task-description">
                                    Description
                                </label>
                            </td>
                            <td>
                                <input type="text" id="task-description" disabled style="width:99%" />
                            </td>
                        </tr>
                    </table>
                    <div style="display:flex; flex-direction:row; width:100%">
                        <div style="width:50%">
                            <table style="padding:5px;">
                                <tr>
                                    <th style="width: 100px; background-color: white; border: none"></th>
                                    <th style="background-color:white; border:none"></th>
                                </tr>
                                <tr>
                                    <td>
                                        <label for="task-on-complete">
                                            On Complete
                                        </label>
                                    </td>
                                    <td>
                                        <input type="text" id="task-on-complete" disabled style="width:95%" />
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div style="width:50%">
                            <table style="padding:5px;">
                                <tr>
                                    <th style="width: 100px; background-color: white; border: none"></th>
                                    <th style="background-color:white; border:none"></th>
                                </tr>
                                <tr>
                                    <td>
                                        <label for="task-on-exception">
                                            On Exception
                                        </label>
                                    </td>
                                    <td>
                                        <input type="text" id="task-on-exception" disabled style="width:95%" />
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="footer" style="height: 25px; background-color: #0d2a48; display: flex; flex-direction: row; justify-content: space-between;">
            <div id="sign-out" style="color: white; display: none; align-items: center; justify-content: space-around;padding:1px 5px; cursor:pointer; white-space:nowrap;" onclick="logOut()">
                <img src="Images/Sign_out.png" />
                Sign Out
            </div>
            <div style="display: flex; flex-direction: row-reverse; align-items: center; padding: 1px 5px; flex-grow: 1; color:white;font-size:20px;">
                <div id="settings" style="cursor:pointer;" onclick="openSettings()">
                    <span><b>&#9881;</b></span>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        const msalConfig = {
            auth: {
                clientId: "00000000-0000-0000-0000-000000000000",//app client ID
                authority: "https://login.microsoftonline.com/00000000-0000-0000-0000-000000000000",//company tenant ID
                redirectUri: "http://localhost",//must be same as control room home page
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false,
            },
            system: {
                loggerOptions: {
                    loggerCallback: (level, message, containsPii) => {
                        if (containsPii) {
                            return;
                        }
                        switch (level) {
                            case msal.LogLevel.Error:
                                console.log(message);
                                return;
                            case msal.LogLevel.Info:
                                console.log(message);
                                return;
                            case msal.LogLevel.Verbose:
                                console.log(message);
                                return;
                            case msal.LogLevel.Warning:
                                console.log(message);
                                return;
                        }
                    }
                }
            }
        };

        const loginRequest = {
            scopes: ["User.Read"]
        };

        const tokenRequest = {
            scopes: ["User.Read"],
            forceRefresh: false
        };
    </script>
    <script type="text/javascript">

        const myMSALObj = new msal.PublicClientApplication(msalConfig);
        let username = "";

        function selectAccount() {
            const currentAccounts = myMSALObj.getAllAccounts();
            if (currentAccounts.length === 0) {
                return;
            } else if (currentAccounts.length > 1) {
                alert("Multiple accounts detected.");
            } else if (currentAccounts.length === 1) {
                username = currentAccounts[0].username;
            }
        }
        function handleResponse(response) {
            if (response !== null) {
                username = response.account.username;
                var data = {
                    ConnectionName: document.getElementById("select-connection").value,
                    Username: "",
                    Password: ""
                };

                fetch(apiUrlBase + "connections/loginsso", {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + response.idToken
                    },
                    body: JSON.stringify(data)
                }).then(res => res.text())
                    .then(data => {
                        const regex = new RegExp(/^([a-zA-Z0-9_=]+)\.([a-zA-Z0-9_=]+)\.([a-zA-Z0-9_\-\+\/=]*)/gm);
                        if (regex.test(data)) {
                            authToken = data;
                            document.getElementById("sso-login-error").innerHTML = "";
                            switchToPostAuthView();
                        }
                        else {
                            document.getElementById("sso-login-error").innerHTML = data;
                        }
                        document.getElementById("sso-login-loading").style.display = "none";
                    })
                    .catch(err => {
                        document.getElementById("sso-login-error").innerHTML = err;
                        document.getElementById("sso-login-loading").style.display = "none";
                    });
            }
            else {
                selectAccount();
            }
        }
        function signInSso() {
            document.getElementById("sso-login-loading").style.display = "inline";

            myMSALObj.loginPopup(loginRequest)
                .then(handleResponse)
                .catch(error => {
                    alert(error);
                });
        }
        function signOut() {
            const logoutRequest = {
                account: myMSALObj.getAccountByUsername(username),
                postLogoutRedirectUri: msalConfig.auth.redirectUri,
                mainWindowRedirectUri: msalConfig.auth.redirectUri
            };

            myMSALObj.logoutPopup(logoutRequest);
        }
        function getTokenPopup(request) {
            request.account = myMSALObj.getAccountByUsername(username);

            return myMSALObj.acquireTokenSilent(request)
                .catch(error => {
                    alert("silent token acquisition fails. acquiring token using popup");
                    if (error instanceof msal.InteractionRequiredAuthError) {
                        return myMSALObj.acquireTokenPopup(request)
                            .then(tokenResponse => {
                                alert(tokenResponse);
                                return tokenResponse;
                            }).catch(error => {
                                alert(error);
                            });
                    } else {
                        alert(error);
                    }
                });
        }

        selectAccount();
    </script>
    <script type="text/javascript">
        let REFRESH_TIMEOUT = 60;//sec; Feel free to adjust for your purposes, here or through settings modal dialog (TODO).
        let apiUrlBase = "http://localhost:3565/";//"https://localhost:44303/";
        let authToken = "";
        let selectedQueueId = "", selectedSessionId = "", selectedScheduleId = "";
        let refreshTimerId = 0;
        let queueManagementIsOpen = false, sessionsManagementIsOpen = false, schedulesManagementIsOpen = false;
        let processes = null, resources, sessions, queues = null, queueItems, logs, schedules = null;
        let filteredSessions = null;
        let sessionsFilter = {
            startTime: "2000-01-01 00:00:00",
            status: "all"
        };

        function resetFilter() {
            sessionsFilter.startTime = "2000-01-01 00:00:00";
            document.getElementById("session-start-date-filter").value = "all";

            sessionsFilter.status = "all";
            document.getElementById("session-status-filter").value = "all";
        }
        function openSettings() {
            document.getElementById("api-url").value = apiUrlBase;
            document.getElementById("refresh-frequency").value = REFRESH_TIMEOUT;
            document.getElementById("modal-window-settings").style.display = "block";
        }
        function applySettings() {
            apiUrlBase = document.getElementById("api-url").value;
            REFRESH_TIMEOUT = document.getElementById("refresh-frequency").value;
            if (REFRESH_TIMEOUT < 30) {
                REFRESH_TIMEOUT = 30;
            }
            if (queueManagementIsOpen || sessionsManagementIsOpen || schedulesManagementIsOpen) {// restart timer with a new delay
                clearTimeout(refreshTimerId);
                refreshTimerId = setInterval(refreshViews, REFRESH_TIMEOUT * 1000);
            }

            initConnectionsList();
            document.getElementById("modal-window-settings").style.display = "none";
        }
        function logIn() {
            var data = {
                ConnectionName: document.getElementById("select-connection").value,
                Username: document.getElementById("username").value,
                Password: document.getElementById("password").value
            };

            document.getElementById("login-loading").style.display = "inline";

            fetch(apiUrlBase + "connections/login", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data)
            }).then(res => res.text())
                .then(data => {
                    const regex = new RegExp(/^([a-zA-Z0-9_=]+)\.([a-zA-Z0-9_=]+)\.([a-zA-Z0-9_\-\+\/=]*)/gm);
                    if (regex.test(data)) {
                        authToken = data;
                        document.getElementById("login-error").innerHTML = "";
                        switchToPostAuthView();
                    }
                    else {
                        document.getElementById("login-error").innerHTML = data;
                    }
                    document.getElementById("login-loading").style.display = "none";
                })
                .catch(err => {
                    document.getElementById("login-error").innerHTML = err;
                    document.getElementById("login-loading").style.display = "none";
                });
        }
        function logOut() {
            authToken = "";
            processes = null;
            queues = null;
            schedules = null;
            resources = null;
            sessions = null;
            resetFilter();
            switchToAuthView();
        }
        window.onclick = function (event) {
            var modal = document.getElementById("modal-window-settings");
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
        document.getElementById("password").addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                logIn();
            }
        });

        function refreshAllSessionManagement() {
            if (queues == null || schedules == null) {
                getControlListData();
            }
            else {
                updateControlList();
            }
            if (processes == null) {
                getProcesses();
            }
            else {
                updateProcessesList();
            }
            getResources();
            getSessions();
        }
        function refreshViews() {
            if (sessionsManagementIsOpen) {
                getResources();
                getSessions();
            }
            if (queueManagementIsOpen) {
                //getQueueItems(null); It's more comfortable updating it manually by Refresh button
            }
        }
        function switchToAuthView() {
            document.getElementById("sign-in-view").style.display = "flex";
            document.getElementById("sign-out").style.display = "none";
            document.getElementById("main-views").style.display = "none";

            sessionsManagementIsOpen = false;
            queueManagementIsOpen = false;
            schedulesManagementIsOpen = false;

            clearTimeout(refreshTimerId);
        }
        function switchToPostAuthView() {
            document.getElementById("sign-in-view").style.display = "none";
            document.getElementById("sign-out").style.display = "flex";
            document.getElementById("main-views").style.display = "flex";

            openSessionManagement();
            sessionsManagementIsOpen = true;
            refreshTimerId = setInterval(refreshViews, REFRESH_TIMEOUT * 1000);
        }
        function initConnectionsList() {
            var combobox = document.getElementById("select-connection");
            combobox.innerHTML = "";
            fetch(apiUrlBase + "Connections")
                .then((res) => res.json())
                .then((data) => {
                    data.forEach((i) => combobox.add(new Option(i, i), undefined));
                });
        }

        function openSessionManagement() {
            document.getElementById("queue-management-views").style.display = "none";
            document.getElementById("schedules-views").style.display = "none";
            document.getElementById("right-views-container").style.display = "flex";

            sessionsManagementIsOpen = true;
            queueManagementIsOpen = false;
            schedulesManagementIsOpen = false;
            refreshAllSessionManagement();
        }
        function openQueueManagement() {
            document.getElementById("queue-management-views").style.display = "flex";
            document.getElementById("schedules-views").style.display = "none";
            document.getElementById("right-views-container").style.display = "none";

            sessionsManagementIsOpen = false;
            queueManagementIsOpen = true;
            schedulesManagementIsOpen = false;
        }
        function openScheduleManagement() {
            document.getElementById("queue-management-views").style.display = "none";
            document.getElementById("schedules-views").style.display = "flex";
            document.getElementById("right-views-container").style.display = "none";

            sessionsManagementIsOpen = false;
            queueManagementIsOpen = false;
            schedulesManagementIsOpen = true;
        }

        function handleScheduleClick(elem) {
            var schedule = schedules.filter((s) => s.id = elem.id)[0];
            document.getElementById("schedule-name").value = schedule.name;
            document.getElementById("schedule-description").value = schedule.description;
            document.getElementById("initial-task").value = schedule.initialTask;

            document.getElementById("schedule-view").style.display = "initial";
            document.getElementById("task-view").style.display = "none";
        }
        function handleTaskClick(elem) {
            var task = schedules.map((g) => g.tasks).flat().filter((t) => t.id == elem.id)[0];
            document.getElementById("task-name").value = task.taskName;
            document.getElementById("task-description").value = task.taskDescription;
            document.getElementById("task-on-complete").value = task.taskOnComplete;
            document.getElementById("task-on-exception").value = task.taskOnException;

            document.getElementById("schedule-view").style.display = "none";
            document.getElementById("task-view").style.display = "initial";
        }

        function handleCaretClick(elem) {
            elem.parentElement.querySelector(".nested").classList.toggle("active");
            elem.classList.toggle("caret-down");
        }

        function selectItem(elem) {
            var listElements = document.querySelectorAll("li.simple, span.caret");
            for (var i = 0; i < listElements.length; i++)
                listElements[i].classList.remove("selected");
            var tableRows = document.querySelectorAll("tbody tr");
            for (var j = 0; j < tableRows.length; j++)
                tableRows[j].classList.remove("selected");
            elem.classList.toggle("selected");
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }
        function dragStartHandler(e) {
            var procId = e.target.id;
            e.dataTransfer.setData("procId", procId);

            var img = new Image();
            img.src = "Images/Process.png";
            e.dataTransfer.setDragImage(img, -5, -5);
            document.getElementById("processes-container").style.overflow = "hidden";
        }
        function dragEndHandler(e) {
            document.getElementById("processes-container").style.overflow = "auto";
        }
        function dragEnterHandler(elem) {
            elem.classList.add("dragged-over");
        }
        function dragLeaveHandler(elem) {
            elem.classList.remove("dragged-over");
        }
        function dropHandler(e) {
            e.target.closest("li").classList.remove("dragged-over");

            var procId = e.dataTransfer.getData("procId");
            var process = processes.map((g) => g.processes).flat().filter((p) => p.id == procId)[0];
            var resourceName = e.target.closest("li").children[0].children[0].innerText;
            if (process.processInput == "") {
                startSession(process.processName, resourceName);
            }
            else {
                const parser = new DOMParser();
                const doc = parser.parseFromString(process.processInput, "application/xml");
                var inputs = doc.querySelectorAll("input");
                var htmlContent = '<div class="modal-content"><h2>Startup Parameters</h2><table>';
                for (var i = 0; i < inputs.length; i++) {
                    htmlContent += '<tr><td><label for= "' + inputs[i].getAttribute("name") + '">'
                        + inputs[i].getAttribute("name") + '</label></td>'
                        + '<td><input type="' + inputs[i].getAttribute("type").replace("datetime", "datetime-local").replace("flag", "checkbox")
                        + '" id="' + inputs[i].getAttribute("name") + '" size="50" title="' + ((inputs[i].getAttribute("narrative")) ?? '') + '"/></td></tr>';
                }
                htmlContent += '</table><br/><br/><div style = "display: flex; width: 100%; align-items: center; justify-content: space-around;" >'
                    + '<input type="hidden" id="input-process-name" value="' + process.processName + '" />'
                    + '<input type="hidden" id="input-resource-name" value="' + resourceName + '" />'
                    + '<button id="btn-apply-inputs" onclick="applyInputParams()">Start</button>'
                    + '<button id="btn-cancel-start" onclick="document.getElementById(\'modal-window-inputs\').style.display = \'none\'">Cancel</button></div >';

                var inputsWindow = document.getElementById("modal-window-inputs");
                inputsWindow.innerHTML = htmlContent;
                inputsWindow.style.display = "block";
            }
        }
        function applyInputParams() {
            var inputs = document.querySelectorAll("#modal-window-inputs table input");
            var startupParams = "<inputs>";
            for (var i = 0; i < inputs.length; i++) {
                switch (inputs[i].getAttribute("type")) {
                    case 'date':
                        if (inputs[i].value == '')
                            break;
                        startupParams += "<input name='" + inputs[i].id + "' type='date' value='" + inputs[i].value + "' />";
                        break;
                    case 'datetime-local':
                        if (inputs[i].value == '')
                            break;
                        var date = new Date(inputs[i].value);
                        startupParams += "<input name='" + inputs[i].id + "' type='datetime' value='" + inputs[i].value.replace('T', ' ') + ":00' />";
                        break;
                    case 'checkbox':
                        startupParams += "<input name='" + inputs[i].id + "' type='flag' value='" + (inputs[i].checked ? 'True' : 'False') + "' />";
                        break;
                    case 'number':
                        if (inputs[i].value == '')
                            break;
                        startupParams += "<input name='" + inputs[i].id + "' type='number' value='" + inputs[i].value + "' />";
                        break;
                    case 'password':
                        if (inputs[i].value == '')
                            break;
                        startupParams += "<input name='" + inputs[i].id + "' type='password' value='" + inputs[i].value + "' />";
                        break;
                    case 'text':
                        startupParams += "<input name='" + inputs[i].id + "' type='text' value='" + inputs[i].value + "' />";
                        break;
                    case 'time':
                        if (inputs[i].value == '')
                            break;
                        startupParams += "<input name='" + inputs[i].id + "' type='time' value='" + inputs[i].value + "' />";
                        break;
                }
            }
            startupParams += "</inputs>";
            var processName = document.getElementById("input-process-name").value;
            var resourceName = document.getElementById("input-resource-name").value;
            document.getElementById("modal-window-inputs").style.display = "none";

            startSession(processName, resourceName, startupParams);
        }

        function expandTreeView(elemId) {
            var expandableItems = document.querySelectorAll("#" + elemId + " .caret");
            for (var i = 0; i < expandableItems.length; i++) {
                expandableItems[i].click();
            }
        };

        function updateProcessesList() {
            var htmlContent = "";
            for (var i = 0; i < processes.length; i++) {
                htmlContent += '<li><span class="caret" onclick = "handleCaretClick(this)"><img src="Images/Folder.png"/>'
                    + processes[i].group
                    + '</span><ul class="nested">';
                for (var j = 0; j < processes[i].processes.length; j++) {
                    htmlContent += '<li id="' + processes[i].processes[j].id + '" class="simple" draggable="true" onclick="selectItem(this)" ondragstart="dragStartHandler(event)" ondragend="dragEndHandler(event)">'
                        + '<div style = "display:flex; flex-direction:row;">'
                        + '<div style="width:300px; overflow:hidden;">'
                        + '<img src="Images/Process.png" /><span>' + processes[i].processes[j].processName
                        + '</span></div><div style="width:max-content; overflow:hidden;">' + processes[i].processes[j].processDescription
                        + '</div></div ></li >';
                }
                htmlContent += '</ul ></li >';
            }
            document.getElementById("processes-list").innerHTML = htmlContent;

            expandTreeView("processes-list");
        }
        function getProcesses() {
            document.getElementById("processes-list").innerHTML = '<li><img id="login-loading" src="Images/Wait.gif" style="width:50px; margin:5px;" /></li>';
            fetch(apiUrlBase + "availableprocesses", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + authToken,
                }
            }).then(res => res.json())
                .then(data => {
                    processes = data;
                    updateProcessesList();
                })
                .catch(err => {
                    document.getElementById("processes-list").innerHTML = '<li style="color:red;">' + err + '</li>';
                    processes = null;
                });
        }

        function updateResourcesList() {
            var htmlContent = "";
            for (var i = 0; i < resources.length; i++) {
                htmlContent += '<li><span class="caret" onclick = "handleCaretClick(this)"><img src="Images/Folder.png" />'
                    + resources[i].group
                    + '</span><ul class="nested">';
                for (var j = 0; j < resources[i].resources.length; j++) {
                    var imageFile = "", color = "color:black;";
                    switch (resources[i].resources[j].resourceStatus) {
                        case 'Idle':
                            imageFile = "R_idle.png";
                            break;
                        case 'Idle-Pending':
                        case 'Working':
                            imageFile = "R_busy.png";
                            color = "color:green;"
                            break;
                        case 'Logged Out':
                            imageFile = "R_logged_out.png";
                            break;
                        default://Missing
                            imageFile = "R_missing.png";
                            color = "color:red;"
                            break;
                    }
                    htmlContent += '<li class="simple" ondragover="allowDrop(event)" onclick="selectItem(this)" ondragenter="dragEnterHandler(this)" ondragleave="dragLeaveHandler(this)" ondrop="dropHandler(event)">'
                        + '<div style = "display:flex; flex-direction:row;' + color + '">'
                        + '<div style="width:200px; overflow:hidden;">'
                        + '<img src="Images/' + imageFile + '">'
                        + resources[i].resources[j].resourceName
                        + '</div><div style="width:max-content; overflow:hidden;">'
                        + resources[i].resources[j].resourceStatus
                        + '</div></div ></li >';
                }
                htmlContent += '</ul ></li >';
            }
            document.getElementById("resources-list").innerHTML = htmlContent;

            expandTreeView("resources-list");
        }
        function getResources() {
            document.getElementById("resources-list").innerHTML = '<li><img id="login-loading" src="Images/Wait.gif" style="width:50px; margin:5px;" /></li>';
            fetch(apiUrlBase + "resources", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + authToken,
                }
            }).then(res => res.json())
                .then(data => {
                    resources = data;
                    updateResourcesList();
                })
                .catch(err => {
                    document.getElementById("resources-list").innerHTML = '<li style="color:red;">' + err + '</li>';
                });
        }

        function setFilteredSessions() {
            filteredSessions = sessions.filter((s) => s.startTime > sessionsFilter.startTime
                && (sessionsFilter.status == "all" || s.status == sessionsFilter.status));
        }
        function updateSessionsList() {
            var htmlContent = '';
            var color = '';
            setFilteredSessions();
            for (var i = 0; i < filteredSessions.length; i++) {
                switch (filteredSessions[i].status) {
                    case 'Completed':
                        color = 'style="color:blue"';
                        break;
                    case 'Stopped':
                        color = 'style="color:red"';
                        break;
                    case 'Terminated':
                        color = 'style="color:black"';
                        break;
                    case 'Pending':
                        color = 'style="color:orange"';
                        break;
                    default:
                        color = 'style="color:green"';
                        break;
                }
                htmlContent += '<tr id="' + filteredSessions[i].id + '" onclick="selectItem(this)" oncontextmenu="sessionContextMenuHandler(event)" ' + color + ' ondblclick="selectedSessionId = this.id; getLogItems();">';
                htmlContent += '<td>' + filteredSessions[i].number + '</td>'
                    + '<td>' + filteredSessions[i].process + '</td>'
                    + '<td>' + filteredSessions[i].resource + '</td>'
                    + '<td>' + filteredSessions[i].user + '</td>'
                    + '<td>' + filteredSessions[i].status + '</td>'
                    + '<td>' + filteredSessions[i].startTime.split('.')[0].replace('T', ' ') + '</td>'
                    + '<td>' + (filteredSessions[i].endTime == null ? '' : filteredSessions[i].endTime.split('.')[0].replace('T', ' ')) + '</td>'
                    + '<td>' + (filteredSessions[i].latestStage == null ? '' : filteredSessions[i].latestStage) + '</td></tr>';
            }
            document.querySelector("#sessions-table tbody").innerHTML = htmlContent;
        }
        function getSessions() {
            document.querySelector("#sessions-table tbody").innerHTML = '<tr><td><img id="login-loading" src="Images/Wait.gif" style="width:50px; margin:5px;" /></td></tr>';
            fetch(apiUrlBase + "environment", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + authToken,
                }
            }).then(res => res.json())
                .then(data => {
                    sessions = data;
                    updateSessionsList();
                })
                .catch(err => {
                    document.querySelector("#sessions-table tbody").innerHTML = '<tbody><tr style="color:red;"><td>' + err + '</td></tr></tbody>';
                });
        }
        function startSession(process, resource, inputs = null) {
            var data = {
                ProcessName: process,
                ResourceName: resource,
                InputParameters: inputs
            };
            fetch(apiUrlBase + "environment", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + authToken,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            }).then(res => res.text())
                .then(text => {
                    if (text.startsWith("Success")) {
                        getResources();
                        getSessions();
                    }
                    else {
                        alert(text);
                    }
                })
                .catch(err => {
                    alert(err);
                });
        }
        function stopSession() {
            document.getElementById("sessions-context-menu").classList.remove("visible");

            fetch(apiUrlBase + "environment/requeststop/" + selectedSessionId, {
                method: "DELETE",
                headers: {
                    "Authorization": "Bearer " + authToken
                }
            }).then(res => res.text())
                .then(text => {
                    if (text.startsWith("Success")) {
                        getResources();
                        getSessions();
                    }
                    else {
                        alert(text);
                    }
                })
                .catch(err => {
                    alert(err);
                });
        }
        function stopSessionImmediately() {
            document.getElementById("sessions-context-menu").classList.remove("visible");

            fetch(apiUrlBase + "environment/immediatestop/" + selectedSessionId, {
                method: "DELETE",
                headers: {
                    "Authorization": "Bearer " + authToken
                }
            }).then(res => res.text())
                .then(text => {
                    if (text.startsWith("Success")) {
                        sleep(2000).then(() => {
                            getResources();
                            getSessions();
                        });
                    }
                    else {
                        alert(text);
                    }
                })
                .catch(err => {
                    alert(err);
                });
        }

        function updateControlList() {
            var htmlContent = '<li id="session-management" class="simple" style="padding-left:15px;margin-bottom:5px;" onclick="selectItem(this); openSessionManagement()">'
                + '<img src = "Images/Session_mngmt.png" /> Session Management'
                + '</li ><li><span class="caret" onclick="handleCaretClick(this)"><img src="Images/Queue_mngmt.png" />Queue Management</span>'
                + '<ul class="nested">';
            for (var i = 0; i < queues.length; i++) {
                if (queues[i].group != null) {
                    htmlContent += '<li><span class="caret" onclick = "handleCaretClick(this)" > <img src="Images/Folder.png" />'
                        + queues[i].group + '</span>'
                        + '<ul class="nested">';
                    for (var j = 0; j < queues[i].workQueues.length; j++) {
                        htmlContent += '<li id="' + queues[i].workQueues[j].id +
                            '" class="simple" onclick="selectItem(this); updateQueuesTable(this); getQueueItems(this); openQueueManagement()">'
                            + '<img src="Images/Wq.png" />'
                            + queues[i].workQueues[j].workQueueName + '</li>';
                    }
                    htmlContent += '</ul></li>';
                }
                else {
                    for (var j = 0; j < queues[i].workQueues.length; j++) {
                        htmlContent += '<li id="' + queues[i].workQueues[j].id +
                            '" class="simple" onclick="selectItem(this); updateQueuesTable(this); getQueueItems(this); openQueueManagement()">'
                            + '<img src="Images/Wq.png" />'
                            + queues[i].workQueues[j].workQueueName + '</li>';
                    }
                }
            }

            htmlContent += '</ul></li><li><span class="caret" onclick="handleCaretClick(this)"><img src="Images/Schedule.png" />Schedules</span>'
                + '<ul class="nested">';
            for (var i = 0; i < schedules.length; i++) {
                htmlContent += '<li><span id="' + schedules[i].id
                    + '" class="caret" onclick="handleCaretClick(this); selectItem(this); openScheduleManagement(); handleScheduleClick(this);"'
                    + ' oncontextmenu="scheduleContextMenuHandler(event)">'
                    + ' <img src="Images/Schedule.png" />'
                    + schedules[i].name + '</span>'
                    + '<ul class="nested">';
                for (var j = 0; j < schedules[i].tasks.length; j++) {
                    htmlContent += '<li class="simple" id="' + schedules[i].tasks[j].id
                        + '" onclick="selectItem(this); openScheduleManagement(); handleTaskClick(this);">'
                        + '<img src="Images/Task.png" />'
                        + schedules[i].tasks[j].taskName + '</li>';
                }
                htmlContent += '</ul></li>';
            }
            htmlContent += '</ul></li>';

            document.getElementById("control-items-list").innerHTML = htmlContent;

            //expandTreeView("control-items-list");
            document.getElementById("session-management").classList.toggle("selected");
        }
        function getControlListData() {
            document.getElementById("control-items-list").innerHTML = '<li><img id="login-loading" src="Images/Wait.gif" style="width:50px; margin:5px;" /></tr>';
            const fetchQueues = async () => {
                var res = await fetch(apiUrlBase + "queuemanagement", {
                    method: "GET",
                    headers: {
                        "Authorization": "Bearer " + authToken,
                    }
                });
                queues = await res.json();
            };
            const fetchSchedules = async () => {
                var res = await fetch(apiUrlBase + "schedules", {
                    method: "GET",
                    headers: {
                        "Authorization": "Bearer " + authToken,
                    }
                });
                schedules = await res.json();
            };
            Promise.all([fetchQueues(), fetchSchedules()])
                .then(res => {
                    updateControlList();
                })
                .catch(err => {
                    document.getElementById("control-items-list").innerHTML = '<li style="color:red;">' + err + '</li>';
                    queues = null;
                });
        }

        function updateQueuesTable(elem) {
            var queueId = elem.id;
            var queuesGroup = queues.filter((g) => g.workQueues.filter((q) => q.id == queueId).length == 1);
            document.getElementById("queues-title").innerHTML = '<b>' + queuesGroup[0].workQueues.length + ' queues</b>';
            var htmlContent = '<thead><tr style="text-align: left;">'
                + '<th>Queue Name</th><th>Status</th><th>Worked</th><th>Pending</th>'
                + '<th>Referred</th><th>Total</th><th>Average Case Duration</th></tr></thead><tbody>';
            for (var i = 0; i < queuesGroup[0].workQueues.length; i++) {
                htmlContent += '<tr id="' + queuesGroup[0].workQueues[i].id + '" onclick="selectItem(this);  getQueueItems(this);">'
                    + '<td><img src="Images/' + (queuesGroup[0].workQueues[i].status == "Running" ? 'Queue_running.png' : 'Queue_paused.png') + '" /> '
                    + queuesGroup[0].workQueues[i].workQueueName + '</td>'
                    + '<td>' + queuesGroup[0].workQueues[i].status + '</td>'
                    + '<td>' + queuesGroup[0].workQueues[i].workedItems + '</td>'
                    + '<td>' + queuesGroup[0].workQueues[i].pendingItems + '</td>'
                    + '<td>' + queuesGroup[0].workQueues[i].referredItems + '</td>'
                    + '<td>' + queuesGroup[0].workQueues[i].totalItems + '</td>'
                    + '<td>' + (queuesGroup[0].workQueues[i].averageCaseDuration == null ? '' : new Date(queuesGroup[0].workQueues[i].averageCaseDuration * 1000).toISOString().slice(11, 19)) + '</td></tr>';
            }
            htmlContent += '</tbody>';
            document.getElementById("work-queues-table").innerHTML = htmlContent;
        }
        function updateQueueItemsTable() {
            var htmlContent = '<thead><tr style = "text-align: left;" >'
                + '<th></th><th style="min-width:60px;">Item Key</th><th>Priority</th><th>Status</th>'
                + '<th>Tags</th><th>Resource</th><th>Attempt</th><th>Created</th><th>Last Updated</th>'
                + '<th>Next Review</th><th>Completed</th><th>Total Work Time</th><th>Exception Date</th>'
                + '<th>Exception Reason</th></tr></thead><tbody>';
            for (var i = 0; i < queueItems.length; i++) {
                var imageFile = "";
                switch (queueItems[i].state) {
                    case 'Exception':
                        imageFile = "Item_exc.png";
                        break;
                    case 'Pending':
                        imageFile = "Item_pending.png";
                        break;
                    case 'Completed':
                        imageFile = "Item_done.png";
                        break;
                    default:
                        imageFile = "Item_locked.png";
                        break;
                }
                htmlContent += '<tr onclick="selectItem(this)">'
                    + '<td><img src="Images/' + imageFile + '" /></td>'
                    + '<td>' + queueItems[i].itemKey + '</td>'
                    + '<td>' + queueItems[i].priority + '</td>'
                    + '<td>' + queueItems[i].status + '</td>'
                    + '<td>' + (queueItems[i].tag == null ? '' : queueItems[i].tag) + '</td>'
                    + '<td>' + queueItems[i].resource + '</td>'
                    + '<td>' + queueItems[i].attempt + '</td>'
                    + '<td>' + new Date(queueItems[i].created).toISOString().split('.')[0].replace("T", " ") + '</td>'
                    + '<td>' + (queueItems[i].lastUpdated == null ? '' : new Date(queueItems[i].lastUpdated).toISOString().split('.')[0].replace("T", " ")) + '</td>'
                    + '<td>' + (queueItems[i].nextReview == null ? '' : new Date(queueItems[i].nextReview).toISOString().split('.')[0].replace("T", " ")) + '</td>'
                    + '<td>' + (queueItems[i].completed == null ? '' : new Date(queueItems[i].completed).toISOString().split('.')[0].replace("T", " ")) + '</td>'
                    + '<td>' + new Date(queueItems[i].totalWorkTime * 1000).toISOString().slice(11, 19) + '</td>'
                    + '<td>' + (queueItems[i].exceptionDate == null ? '' : new Date(queueItems[i].exceptionDate).toISOString().split('.')[0].replace("T", " ")) + '</td>'
                    + '<td>' + (queueItems[i].exceptionReason == null ? '' : queueItems[i].exceptionReason) + '</td></tr>';
            }
            htmlContent += '</tbody>';
            document.getElementById("work-items-table").innerHTML = htmlContent;
        }
        function getQueueItems(elem) {
            selectedQueueId = (elem == null ? selectedQueueId : elem.id);
            document.getElementById("work-items-table").innerHTML = '<tr><td><img id="login-loading" src="Images/Wait.gif" style="width:50px; margin:5px;" /></td></tr>';
            fetch(apiUrlBase + "queuecontents/" + selectedQueueId, {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + authToken,
                }
            }).then(res => res.json())
                .then(data => {
                    queueItems = data;
                    //var queueName = queues.filter((g) => g.workQueues.filter((q) => q.id == selectedQueueId).length == 1)[0].workQueues.filter((q) => q.id == selectedQueueId)[0].workQueueName;
                    var queueName = queues.map((g) => g.workQueues).flat().filter((q) => q.id == selectedQueueId)[0].workQueueName;
                    document.getElementById("queue-items-title").innerHTML = '<b>Queue contents: ' + queueName + '</b>';
                    updateQueueItemsTable();
                })
                .catch(err => {
                    document.getElementById("work-items-table").innerHTML = '<tbody><tr style="color:red;"><td>' + err + '</td></tr></tbody>';
                });
        }

        function openLog(id) {
            var session = sessions.filter((s) => s.id == id)[0];
            var htmlContent = '<html><head><title>Session Log Viewer</title><link rel="icon" href="Images/favicon.png">'
                + '<style>td{border: 1px solid #eeeeee;padding: 2px 5px 2px 5px; white-space: nowrap; overflow: hidden;} '
                + 'th{border-right: 1px solid #a0a0a0;padding: 2px 5px 2px 5px;white-space: nowrap;'
                + 'overflow: hidden;position: sticky;top: 0px;background: #f6f6f6;}'
                + 'span {white-space: nowrap;} </style > '
                + '<scr' + 'ipt type="text/javascript">function ChangeColor(tableRow, highLight) {if (highLight) {'
                + 'tableRow.style.backgroundColor = "#92bafa";}else {tableRow.style.backgroundColor = "white";}}</scr' + 'ipt>'
                + '</head><body style="margin: 0px;">';
            htmlContent += '<div style="display: flex; flex-direction: column; width: 100%; height: 100%;">'
                + '<div style="padding-left: 10px; background-color: #0d2a48; color: white; font-family: Arial, Helvetica, sans-serif; font-size: medium; display:flex; flex-direction: column;">'
                + '<p style="margin: 5px 0px;">Process: ' + session.process + '</p>'
                + '<p style="margin: 5px 0px;">Session Date: ' + session.startTime.replace('T', ' ') + '</p></div>'
                + '<div style="flex-grow:1; border: 1px solid black; margin: 2px 5px 0 5px; overflow: auto; font-family: Arial, Helvetica, sans-serif; font-size: small;">'
                + '<table style="border-spacing: 0; min-width: 100%;"><tr><th>Stage Name</th><th>Stage Type</th><th>Process</th><th>Page</th><th>Object</th>'
                + '<th>Action</th><th>Result</th><th>Resource Start</th><th>Resource End</th><th>Parameters</th></tr>';
            for (var i = 0; i < logs.length; i++) {
                var parameters = "";
                if (logs[i].parameters != "") {
                    var parser = new DOMParser();
                    var doc = parser.parseFromString(logs[i].parameters, "application/xml");
                    var inputs = doc.querySelectorAll("input");
                    for (var j = 0; j < inputs.length; j++) {
                        if (inputs[j].getAttribute("type") != "collection") {
                            parameters += "<span>(IN)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>Name:</b><i>" + inputs[j].getAttribute("name") + "</i> <b>Value:</b><i>" + inputs[j].getAttribute("value") + "</i></span><br/>\n";
                        }
                        else {
                            parameters += "<span>(IN)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>Name:</b><i>" + inputs[j].getAttribute("name") + "</i> (Collection)</span><br/>\n";
                            var rows = inputs[j].querySelectorAll("row");
                            for (var k = 0; k < rows.length; k++) {
                                parameters += "<span>&nbsp;&nbsp;&nbsp;Row " + (k + 1) + ":</span><br/>\n";
                                var fields = rows[k].querySelectorAll("field");
                                for (var l = 0; l < fields.length; l++) {
                                    parameters += "<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>" + fields[l].getAttribute("name") + ":</b><i>" + fields[l].getAttribute("value") + "</i></span><br/>\n";
                                }
                            }
                        }
                    }
                    var outputs = doc.querySelectorAll("output");
                    for (var j = 0; j < outputs.length; j++) {
                        if (outputs[j].getAttribute("type") != "collection") {
                            parameters += "<span>(OUT) <b>Name:</b><i>" + outputs[j].getAttribute("name") + "</i> <b>Value:</b><i>" + outputs[j].getAttribute("value") + "</i></span><br/>\n";
                        }
                        else {
                            parameters += "<span>(OUT) <b>Name:</b><i>" + outputs[j].getAttribute("name") + "</i> (Collection)</span><br/>\n";
                            var rows = outputs[j].querySelectorAll("row");
                            for (var k = 0; k < rows.length; k++) {
                                parameters += "<span>&nbsp;&nbsp;&nbsp;Row " + (k + 1) + ":</span><br/>\n";
                                var fields = rows[k].querySelectorAll("field");
                                for (var l = 0; l < fields.length; l++) {
                                    parameters += "<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>" + fields[l].getAttribute("name") + ":</b><i>" + fields[l].getAttribute("value") + "</i></span><br/>\n";
                                }
                            }
                        }
                    }
                }

                htmlContent += '<tr onmouseover="ChangeColor(this, true)" onmouseout="ChangeColor(this, false)"><td>' + logs[i].stageName + '</td>'
                    + '<td>' + logs[i].stageType + '</td>'
                    + '<td>' + logs[i].process + '</td>'
                    + '<td>' + logs[i].page + '</td>'
                    + '<td>' + logs[i].object + '</td>'
                    + '<td>' + logs[i].action + '</td>'
                    + '<td>' + logs[i].result + '</td>'
                    + '<td>' + logs[i].resourceStart.replace('T', ' ') + '</td>'
                    + '<td>' + (logs[i].resourceEnd == null ? '' : logs[i].resourceEnd.replace('T', ' ')) + '</td>'
                    + '<td style="white-space: normal;">' + parameters + '</td></tr>';
            }
            htmlContent += '</table></div></div></body></html>';

            var newWindow = window.open();
            newWindow.document.write(htmlContent);
        }
        function getLogItems() {
            document.getElementById("sessions-context-menu").classList.remove("visible");

            var session = sessions.filter((s) => s.id == selectedSessionId)[0];
            fetch(apiUrlBase + "logs/" + session.number, {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + authToken,
                }
            }).then(res => res.json())
                .then(data => {
                    logs = data;
                    openLog(session.id);
                })
                .catch(err => {
                    alert(err);
                });
        }

        function runSchedule() {
            document.getElementById("schedules-context-menu").classList.remove("visible");

            var scheduleName = schedules.filter((s) => s.id == selectedScheduleId)[0].name;

            var data = {
                ScheduleName: scheduleName
            };
            fetch(apiUrlBase + "schedules", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + authToken,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            }).then(res => res.text())
                .then(text => {
                    if (!text.startsWith("Success")) {
                        alert(text);
                    }
                })
                .catch(err => {
                    alert(err);
                });
        }

        function applySessionsFilter(elem) {
            switch (elem.id) {
                case "session-start-date-filter": {
                    var lowerBoundDate = new Date();
                    switch (elem.value) {
                        case "all":
                            sessionsFilter.startTime = "2000-01-01T00:00:00";
                            break;
                        case "today":
                            sessionsFilter.startTime = lowerBoundDate.getFullYear() + '-'
                                + (lowerBoundDate.getMonth() + 1).toString().padStart(2, 0) + "-"
                                + lowerBoundDate.getDate().toString().padStart(2, 0) + 'T00:00:00';
                            break;
                        default:
                            lowerBoundDate.setTime(lowerBoundDate.getTime() - elem.value * 60 * 60 * 1000);
                            sessionsFilter.startTime = lowerBoundDate.getFullYear() + '-'
                                + (lowerBoundDate.getMonth() + 1).toString().padStart(2, 0) + "-"
                                + lowerBoundDate.getDate().toString().padStart(2, 0) + 'T'
                                + lowerBoundDate.getHours().toString().padStart(2, 0) + ':'
                                + lowerBoundDate.getMinutes().toString().padStart(2, 0) + ':'
                                + lowerBoundDate.getSeconds().toString().padStart(2, 0);
                            break;
                    }
                    break;
                }
                case "session-status-filter": {
                    sessionsFilter.status = elem.value;
                }
            }

            updateSessionsList();
        }

        function sessionContextMenuHandler(e) {
            e.preventDefault();
            selectedSessionId = e.target.closest("tr").id;
            var sessionStatus = sessions.filter((s) => s.id == selectedSessionId)[0].status;
            if (sessionStatus != "Running") {
                document.getElementById("request-stop-option").style.display = "none";
                document.getElementById("immediate-stop-option").style.display = "none";
            }
            else {
                document.getElementById("request-stop-option").style.display = "inherit";
                document.getElementById("immediate-stop-option").style.display = "inherit";
            }

            var contextMenu = document.getElementById("sessions-context-menu");
            const { clientX: mouseX, clientY: mouseY } = e;
            contextMenu.style.top = mouseY + 'px';
            contextMenu.style.left = mouseX + 'px';
            contextMenu.classList.add("visible");
        }
        function scheduleContextMenuHandler(e) {
            e.preventDefault();
            selectedScheduleId = e.target.id;

            var contextMenu = document.getElementById("schedules-context-menu");
            const { clientX: mouseX, clientY: mouseY } = e;
            contextMenu.style.top = mouseY + 'px';
            contextMenu.style.left = mouseX + 'px';
            contextMenu.classList.add("visible");
        }
        function clickContextMenuHandler(e) {
            var sessionsContextMenu = document.getElementById("sessions-context-menu");
            var schedulesContextMenu = document.getElementById("schedules-context-menu");
            if (e.target.offsetParent != sessionsContextMenu) {
                sessionsContextMenu.classList.remove("visible");
            }
            if (e.target.offsetParent != schedulesContextMenu) {
                schedulesContextMenu.classList.remove("visible");
            }
        }

        function sleep(time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }

        initConnectionsList();
    </script>
</body>
</html>